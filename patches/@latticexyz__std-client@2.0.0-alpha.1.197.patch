diff --git a/dist/index.js b/dist/index.js
index 61600e70073799e38171143c504d2eabbea2d333..2db3b11086672f4c5b64197d9ea17cff5e502d64 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -1,2 +1,2 @@
-import{a as _}from"./chunk-64VNNNML.js";import{defineComponent as Ae,Type as Me}from"@latticexyz/recs";function Ne(t){return Ae(t,{value:Me.OptionalNumber},{id:"DevHighlight"})}import{defineComponent as ke,Type as We}from"@latticexyz/recs";function Oe(t,e){return ke(t,{value:We.Number},e)}import{defineComponent as Re,Type as He}from"@latticexyz/recs";function De(t,e){return Re(t,{value:He.Boolean},e)}import{defineComponent as Ve,Type as Y}from"@latticexyz/recs";function Ue(t,e){return Ve(t,{x:Y.Number,y:Y.Number},e)}import{defineComponent as Pe,Type as Be}from"@latticexyz/recs";function D(t,e){return Pe(t,{value:Be.String},e)}import{defineComponent as Fe,Type as M}from"@latticexyz/recs";function F(t){return Fe(t,{state:M.Number,on:M.OptionalEntity,metadata:M.OptionalT,overrides:M.OptionalStringArray,txHash:M.OptionalString},{id:"Action"})}import{defineComponent as $e,Type as $}from"@latticexyz/recs";function je(t,e){return $e(t,{x:$.Number,y:$.Number,z:$.Number},e)}import{getComponentValue as Le,getComponentValueStrict as L,Has as Ke,hasComponent as A,HasValue as Qe,runQuery as qe,componentValueEquals as Ge}from"@latticexyz/recs";import{keccak256 as ze}from"@latticexyz/utils";import{BigNumber as j}from"ethers";import{SingletonID as Je}from"@latticexyz/network";import{deferred as _e}from"@latticexyz/utils";import{filter as Ye}from"rxjs";function zn(t,e){return Xe(t,e.currentTime/1e3)}function Xe(t,e){let o=Ze(t);if(!o)return-1;let r=j.from(o.startTime),i=j.from(o.turnLength);return j.from(Math.floor(e)).sub(r).div(i).toNumber()}function Ze(t){return Le(t,Je)}function Jn(t,e,o){return qe([Qe(e,o),Ke(t)]).size>0}function _n(t,e){if(!t)return;let o=t;if(!(o==null||!A(e,o)))return o}function Yn(t,e){for(;A(t,e);){let o=L(t,e).value;if(!o)return;e=o}return e}function Xn(t,e,o){if(A(o,e))return e;for(;A(t,e);){let r=L(t,e).value;if(r==null)return;if(e=r,A(o,e))return e}}function Zn(t,e,o){if(e===o)return!0;for(;A(t,e);){let r=L(t,e).value;if(r==null)return!1;if(e=r,e===o)return!0}return!1}function et(t){let e=new Array(4);function o(c){for(let s=0;s<e.length;s++)e[s]=0;for(let s=0;s<c.length;s++)e[s%4]=(e[s%4]<<5)-e[s%4]+c.charCodeAt(s)}function r(){let c=e[0]^e[0]<<11;return e[0]=e[1],e[1]=e[2],e[2]=e[3],e[3]=e[3]^e[3]>>19^c^c>>8,(e[3]>>>0)/(1<<31>>>0)}function i(){let c=Math.floor(r()*360)/360,s=80/100,m=70/100;return[c,s,m]}function u(c,s,m){return c<<16|s<<8|m}function d(c,s,m){return m<0&&(m+=1),m>1&&(m-=1),m<1/6?c+(s-c)*6*m:m<1/2?s:m<2/3?c+(s-c)*(2/3-m)*6:c}function a(c,s,m){let x,C,n;if(s===0)x=C=n=m;else{let l=m<.5?m*(1+s):m+s-m*s,f=2*m-l;x=d(f,l,c+1/3),C=d(f,l,c),n=d(f,l,c-1/3)}return[x*255,C*255,n*255]}return o(t),u(...a(...i()))}function eo(t){return et(ze(t).substring(2))}function K(t,e,o){let[r,,i]=_e(),u=r,d=t.update$.pipe(Ye(a=>a.entity===e&&!!o.find(c=>Ge(c,a.value[0])))).subscribe(()=>{r(),u()});return u=()=>d?.unsubscribe(),i}async function to(t,e,o){await K(t,e,[o])}import{defineQuery as tt,toUpdate as nt}from"@latticexyz/recs";import{useEffect as X,useMemo as ot,useState as Z}from"react";import{filter as rt}from"rxjs";function it(t,e){let[o,r]=Z(e);return X(()=>{let i=t.subscribe(u=>r(u));return()=>i?.unsubscribe()},[]),o}function uo(t,e){let o=ot(()=>e!=null?t.update$.pipe(rt(i=>i.entity===e)):t.update$.asObservable(),[t,e]),r=it(o,e!=null?nt(e,t):void 0);return r?r.value[0]:null}function lo(t){let[e,o]=Z();return X(()=>{let r=tt(t,{runOnInit:!0}),i=r.update$.subscribe();return o(r.matching),()=>i?.unsubscribe()},[]),e}import{createEntity as st,getComponentValue as U,overridableComponent as ee,updateComponent as w,setComponent as mt}from"@latticexyz/recs";import{mapObject as ct,awaitStreamValue as dt,uuid as pt}from"@latticexyz/utils";var V=(a=>(a[a.Requested=0]="Requested",a[a.Executing=1]="Executing",a[a.WaitingForTxEvents=2]="WaitingForTxEvents",a[a.Complete=3]="Complete",a[a.Failed=4]="Failed",a[a.Cancelled=5]="Cancelled",a[a.TxReduced=6]="TxReduced",a))(V||{}),at={[6]:"TxReduced",[0]:"Requested",[1]:"Executing",[2]:"WaitingForTxEvents",[3]:"Complete",[4]:"Failed",[5]:"Cancelled"};import{merge as ut}from"rxjs";function lt(t,e){let o=F(t),r={},i=new Map,u=new Map;t.registerDisposer(()=>{for(let{dispose:n}of u.values())n()});function d(n){let l=r[n.id]||ee(n);return r[n.id]||(r[n.id]=l),l}function a(n){if(t.hasEntity(n.id)!=null)return console.warn(`Action with id ${n.id} is already requested.`),n.id;let f=st(t,void 0,{id:n.id});mt(o,f,{state:0,on:n.on,metadata:n.metadata,overrides:void 0,txHash:void 0});for(let[y,S]of Object.entries(n.components))r[y]||(r[y]=ee(S));let p={...n,entity:f,componentsWithOptimisticUpdates:ct(n.components,y=>d(y))};i.set(p.id,p);let b=ut(...Object.values(p.componentsWithOptimisticUpdates).map(y=>y.update$)).subscribe(()=>c(p));return c(p),u.set(p.id,{dispose:()=>b?.unsubscribe()}),f}function c(n){if(U(o,n.entity)?.state!==0)return;let l=n.requirement(n.componentsWithOptimisticUpdates);l&&s(n,l)}async function s(n,l){if(U(o,n.entity)?.state!==0)return;w(o,n.entity,{state:1});let f=n.updates(n.componentsWithOptimisticUpdates,l).map(p=>({...p,id:pt()}));w(o,n.entity,{overrides:f.map(p=>`${p.id}/${p.component}`)});for(let{component:p,value:b,entity:y,id:S}of f)r[p].addOverride(S,{entity:y,value:b});try{let p=await n.execute(l);if(p){w(o,n.entity,{state:2,txHash:p.hash});let b=p.wait().catch(()=>m(n));await dt(e,y=>y===p.hash),w(o,n.entity,{state:6}),n.awaitConfirmation&&await b}w(o,n.entity,{state:3})}catch{m(n)}C(n.id)}function m(n){w(o,n.entity,{state:4}),C(n.id)}function x(n){let l=i.get(n);return!l||U(o,l.entity)?.state!==0?(console.warn(`Action ${n} was not found or is not in the "Requested" state.`),!1):(w(o,l.entity,{state:5}),C(n),!0)}function C(n){if(!i.get(n))throw new Error("Trying to remove an action that does not exist.");let f=n,p=f!=null&&U(o,f)?.overrides||[];for(let b of p){let[y,S]=b.split("/");r[S].removeOverride(y)}u.get(n)?.dispose(),u.delete(n),i.delete(n),f!=null&&setTimeout(()=>t.deleteEntity(f),5e3)}return{add:a,cancel:x,withOptimisticUpdates:d,Action:o}}async function te(t,e){return K(t,e,[{state:5},{state:4},{state:3}])}import{createNetwork as Wt,createContracts as Ot,createTxQueue as Rt,createSyncWorker as Ht,InputType as Dt,SingletonID as me}from"@latticexyz/network";import{BehaviorSubject as Vt,concatMap as Ut,from as Pt,Subject as Bt}from"rxjs";import{defineComponent as ce,Type as W}from"@latticexyz/recs";import{computed as Ft}from"mobx";import{keccak256 as $t,TableId as jt}from"@latticexyz/utils";import{IWorldKernel__factory as de}from"@latticexyz/world/types/ethers-contracts/factories/IWorldKernel.sol/IWorldKernel__factory";import{ack as ne,createEncoder as ft,isNetworkComponentUpdateEvent as yt,isSystemCallEvent as gt}from"@latticexyz/network";import{getComponentValue as bt,removeComponent as Ct,setComponent as St,getComponentEntities as xt,getComponentValueStrict as vt,updateComponent as Tt}from"@latticexyz/recs";import{isDefined as ht,toEthAddress as It}from"@latticexyz/utils";import Et from"@latticexyz/solecs/abi/Component.sol/Component.json";import{Contract as wt,BigNumber as At}from"ethers";import{filter as Mt,map as Nt,Subject as Q,timer as kt}from"rxjs";function ar(t,e,o){return r=>{let i=r.entity??t.registerEntity({id:r.entity}),u=o[r.component],d=e[u];if(!u){console.error(`Component mapping not found for component ID ${r.component} ${JSON.stringify(r.value)}`);return}return{...r,entity:i,component:d}}}function sr(t,e,o,r,i){let u=e.reduce((d,a)=>({...d,[a]:new Q}),{});return{systemCallStreams:u,decodeAndEmitSystemCall:d=>{let{tx:a}=d,c=At.from(a.to).toHexString().toLowerCase();if(!c)return;let s=bt(o,c)?.value;if(!s)return;let{name:m,contract:x}=r(s),C=x.interface.parseTransaction({data:a.data,value:a.value});u[m]||(u[m]=new Q),u[m].next({...d,updates:d.updates.map(i).filter(ht),systemId:m,args:C.args})}}}async function re(t,e,o){let r={};async function i(d){let a=It(d),c=vt(e,d).value;console.info("[SyncUtils] Creating encoder for "+a);let s=new wt(a,Et.abi,o.get()),[m,x]=await s.getSchema();r[c]=ft(m,x)}for(let d of xt(e))i(d);let u=e.update$.subscribe(d=>i(d.entity));return t.registerDisposer(()=>u?.unsubscribe()),r}function ie(t,e,o,r,i,u,d,a){let c=new Q,s=!1,m=kt(0,100).pipe(Mt(()=>!s),Nt(()=>ne)).subscribe(i),x=o.subscribe(C=>{s=!0;for(let n of C)if(yt(n)){if(n.lastEventInTx&&c.next(n.txHash),d&&u){let{namespace:b,table:y,key:S}=n,E=u.tables[y];if(!(!E||b!==u.namespace)){let O=oe(S,Object.getOwnPropertyNames(E.keySchema)),R=n.value??n.partialValue;if(R){let H=oe(R,Object.getOwnPropertyNames(E.schema));d.set(b,y,O,H)}else d.remove(b,y,O)}}let l=n.entity??t.registerEntity({id:n.entity}),f=r[n.component];if(!f){console.warn("Unknown component:",n);continue}let p=e[f];n.partialValue!==void 0?Tt(p,l,n.partialValue,n.initialValue):n.value===void 0?Ct(p,l):St(p,l,n.value)}else a&&gt(n)&&a(n);i.next(ne),s=!1});return t.registerDisposer(()=>{x?.unsubscribe(),m?.unsubscribe()}),{txReduced$:c.asObservable()}}function oe(t,e){let o={};return e.forEach((r,i)=>{i in t&&(o[r]=t[i])}),o}import{TableId as N}from"@latticexyz/utils";import{defineComponent as k,Type as T}from"@latticexyz/recs";function ae(t){return{Hooks:(()=>{let e=new N("mudstore","Hooks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Callbacks:(()=>{let e=new N("mudstore","Callbacks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),StoreMetadata:(()=>{let e=new N("mudstore","StoreMetadata");return k(t,{tableName:T.String,abiEncodedFieldNames:T.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Mixed:(()=>{let e=new N("mudstore","Mixed");return k(t,{u32:T.Number,u128:T.BigInt,a32:T.NumberArray,s:T.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Vector2:(()=>{let e=new N("mudstore","Vector2");return k(t,{x:T.Number,y:T.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})()}}import{TableId as h}from"@latticexyz/utils";import{defineComponent as I,Type as g}from"@latticexyz/recs";function se(t){return{NamespaceOwner:(()=>{let e=new h("","NamespaceOwner");return I(t,{owner:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),ResourceAccess:(()=>{let e=new h("","ResourceAccess");return I(t,{access:g.Boolean},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),InstalledModules:(()=>{let e=new h("","InstalledModules");return I(t,{moduleAddress:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Systems:(()=>{let e=new h("","Systems");return I(t,{system:g.String,publicAccess:g.Boolean},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),SystemRegistry:(()=>{let e=new h("","SystemRegistry");return I(t,{resourceSelector:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),SystemHooks:(()=>{let e=new h("","SystemHooks");return I(t,{value:g.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),ResourceType:(()=>{let e=new h("","ResourceType");return I(t,{resourceType:g.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),FunctionSelectors:(()=>{let e=new h("","FunctionSelector");return I(t,{namespace:g.String,name:g.String,systemFunctionSelector:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),KeysInTable:(()=>{let e=new h("","KeysInTable");return I(t,{keys0:g.StringArray,keys1:g.StringArray,keys2:g.StringArray,keys3:g.StringArray,keys4:g.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),UsedKeysIndex:(()=>{let e=new h("","UsedKeysIndex");return I(t,{has:g.Boolean,index:g.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})()}}import{createDatabase as Lt,createDatabaseClient as Kt}from"@latticexyz/store-cache";async function Hr({networkConfig:t,world:e,contractComponents:o,initialGasPrice:r,fetchSystemCalls:i,syncThread:u,storeConfig:d,syncStoreCache:a=!0,worldAbi:c=de.abi}){_.next(c);let s=D(e,{id:"SystemsRegistry",metadata:{contractId:"world.component.systems"}}),m=D(e,{id:"ComponentsRegistry",metadata:{contractId:"world.component.components"}}),x=ce(e,{state:W.Number,msg:W.String,percentage:W.Number},{id:"LoadingState",metadata:{contractId:"component.LoadingState"}}),C=new jt("mudstore","schema"),n=ce(e,{valueSchema:W.String,keySchema:W.String},{metadata:{contractId:C.toHexString(),tableId:C.toString()}}),l=ae(e),f=se(e),p={storeSchemaComponent:n,...l,...f,...o,SystemsRegistry:s,ComponentsRegistry:m,LoadingState:x},b={};function y(v,B){let{contractId:we,tableId:J}=B.metadata;J?b[J]=v:b[$t(we)]=v}for(let v of Object.keys(p))y(v,p[v]);let S=await Wt(t);e.registerDisposer(S.dispose);let E=Ft(()=>S.signer.get()||S.providers.get().json),{contracts:O,config:R}=await Ot({config:{World:{abi:de.abi,address:t.worldAddress}},signerOrProvider:E}),H=new Vt(r||Math.ceil((await E.get().getGasPrice()).toNumber()*1.3)),{txQueue:fe,dispose:ye}=Rt(O,S,H,{devMode:t.devMode});e.registerDisposer(ye);let ge=e.registerEntity({id:me}),P=S.connectedAddress.get(),be=P?e.registerEntity({id:P}):void 0,q=new Bt,{provider:{externalProvider:Jt,...Ce},...Se}=t,{ecsEvents$:G,input$:xe,dispose:ve}=Ht(q,{thread:u});e.registerDisposer(ve);function Te(v,B){xe.next({type:Dt.Config,data:{...Se,provider:Ce,worldContract:R.World,initialBlockNumber:B??t.initialBlockNumber,disableCache:t.disableCache||[31337,1337].includes(t.chainId),fetchSystemCalls:i,initialRecords:v}})}let he=Lt(),z=Kt(he,d),{txReduced$:Ie}=ie(e,p,G,b,q,a?d:void 0,a?z:void 0),Ee=t.encoders?re(e,m,E):new Promise(v=>v({}));return{txQueue:fe,txReduced$:Ie,encoders:Ee,network:S,startSync:Te,gasPriceInput$:H,ecsEvent$:G.pipe(Ut(v=>Pt(v))),mappings:b,registerComponent:y,networkConfig:t,world:e,components:p,singletonEntityId:me,singletonEntity:ge,playerEntityId:P,playerEntity:be,storeCache:z}}import{generatePrivateKey as Qt,privateKeyToAccount as le}from"viem/accounts";import{isHex as qt}from"viem";import{BehaviorSubject as pe}from"rxjs";function ue(t,e){if(!qt(t))throw console.error("Private key found in cache is not valid hex",{privateKey:t,cacheKey:e}),new Error(`Private key found in cache (${e}) is not valid hex`);le(t)}function Gt(t="mud:burnerWallet"){let e=localStorage.getVoxelType(t);e!=null&&ue(e,t);let o=e!=null?new pe(e):(()=>{let r=Qt();return console.log("New burner wallet created:",le(r)),localStorage.setVoxelType(t,r),new pe(r)})();return window.addEventListener("storage",function r(i){if(o.closed){window.removeEventListener("storage",r);return}if(i.key===t&&i.storageArea===localStorage){if(!i.newValue){console.warn("Burner wallet removed from cache! You may need to reload to create a new wallet.");return}ue(i.newValue,t),o.next(i.newValue)}}),o}export{V as ActionState,at as ActionStateString,ie as applyNetworkUpdates,lt as createActionSystem,ar as createDecodeNetworkComponentUpdate,re as createEncoders,sr as createSystemCallStreams,F as defineActionComponent,De as defineBoolComponent,Ue as defineCoordComponent,Ne as defineDevHighlightComponent,Oe as defineNumberComponent,D as defineStringComponent,je as defineVoxelCoordComponent,Xn as findEntityWithComponentInRelationshipChain,Zn as findInRelationshipChain,Gt as getBurnerWallet,zn as getCurrentTurn,Ze as getGameConfig,_n as getPlayerEntity,eo as getStringColor,Xe as getTurnAtTime,Jn as isUntraversable,et as randomColor,Yn as resolveRelationshipChain,Hr as setupMUDV2Network,uo as useComponentValueStream,lo as useQuery,it as useStream,te as waitForActionCompletion,to as waitForComponentValue,K as waitForComponentValueIn};
+import{a as _}from"./chunk-64VNNNML.js";import{defineComponent as Ae,Type as Me}from"@latticexyz/recs";function Ne(t){return Ae(t,{value:Me.OptionalNumber},{id:"DevHighlight"})}import{defineComponent as ke,Type as We}from"@latticexyz/recs";function Oe(t,e){return ke(t,{value:We.Number},e)}import{defineComponent as Re,Type as He}from"@latticexyz/recs";function De(t,e){return Re(t,{value:He.Boolean},e)}import{defineComponent as Ve,Type as Y}from"@latticexyz/recs";function Ue(t,e){return Ve(t,{x:Y.Number,y:Y.Number},e)}import{defineComponent as Pe,Type as Be}from"@latticexyz/recs";function D(t,e){return Pe(t,{value:Be.String},e)}import{defineComponent as Fe,Type as M}from"@latticexyz/recs";function F(t){return Fe(t,{state:M.Number,on:M.OptionalEntity,metadata:M.OptionalT,overrides:M.OptionalStringArray,txHash:M.OptionalString},{id:"Action"})}import{defineComponent as $e,Type as $}from"@latticexyz/recs";function je(t,e){return $e(t,{x:$.Number,y:$.Number,z:$.Number},e)}import{getComponentValue as Le,getComponentValueStrict as L,Has as Ke,hasComponent as A,HasValue as Qe,runQuery as qe,componentValueEquals as Ge}from"@latticexyz/recs";import{keccak256 as ze}from"@latticexyz/utils";import{BigNumber as j}from"ethers";import{SingletonID as Je}from"@latticexyz/network";import{deferred as _e}from"@latticexyz/utils";import{filter as Ye}from"rxjs";function zn(t,e){return Xe(t,e.currentTime/1e3)}function Xe(t,e){let o=Ze(t);if(!o)return-1;let r=j.from(o.startTime),i=j.from(o.turnLength);return j.from(Math.floor(e)).sub(r).div(i).toNumber()}function Ze(t){return Le(t,Je)}function Jn(t,e,o){return qe([Qe(e,o),Ke(t)]).size>0}function _n(t,e){if(!t)return;let o=t;if(!(o==null||!A(e,o)))return o}function Yn(t,e){for(;A(t,e);){let o=L(t,e).value;if(!o)return;e=o}return e}function Xn(t,e,o){if(A(o,e))return e;for(;A(t,e);){let r=L(t,e).value;if(r==null)return;if(e=r,A(o,e))return e}}function Zn(t,e,o){if(e===o)return!0;for(;A(t,e);){let r=L(t,e).value;if(r==null)return!1;if(e=r,e===o)return!0}return!1}function et(t){let e=new Array(4);function o(c){for(let s=0;s<e.length;s++)e[s]=0;for(let s=0;s<c.length;s++)e[s%4]=(e[s%4]<<5)-e[s%4]+c.charCodeAt(s)}function r(){let c=e[0]^e[0]<<11;return e[0]=e[1],e[1]=e[2],e[2]=e[3],e[3]=e[3]^e[3]>>19^c^c>>8,(e[3]>>>0)/(1<<31>>>0)}function i(){let c=Math.floor(r()*360)/360,s=80/100,m=70/100;return[c,s,m]}function u(c,s,m){return c<<16|s<<8|m}function d(c,s,m){return m<0&&(m+=1),m>1&&(m-=1),m<1/6?c+(s-c)*6*m:m<1/2?s:m<2/3?c+(s-c)*(2/3-m)*6:c}function a(c,s,m){let x,C,n;if(s===0)x=C=n=m;else{let l=m<.5?m*(1+s):m+s-m*s,f=2*m-l;x=d(f,l,c+1/3),C=d(f,l,c),n=d(f,l,c-1/3)}return[x*255,C*255,n*255]}return o(t),u(...a(...i()))}function eo(t){return et(ze(t).substring(2))}function K(t,e,o){let[r,,i]=_e(),u=r,d=t.update$.pipe(Ye(a=>a.entity===e&&!!o.find(c=>Ge(c,a.value[0])))).subscribe(()=>{r(),u()});return u=()=>d?.unsubscribe(),i}async function to(t,e,o){await K(t,e,[o])}import{defineQuery as tt,toUpdate as nt}from"@latticexyz/recs";import{useEffect as X,useMemo as ot,useState as Z}from"react";import{filter as rt}from"rxjs";function it(t,e){let[o,r]=Z(e);return X(()=>{let i=t.subscribe(u=>r(u));return()=>i?.unsubscribe()},[]),o}function uo(t,e){let o=ot(()=>e!=null?t.update$.pipe(rt(i=>i.entity===e)):t.update$.asObservable(),[t,e]),r=it(o,e!=null?nt(e,t):void 0);return r?r.value[0]:null}function lo(t){let[e,o]=Z();return X(()=>{let r=tt(t,{runOnInit:!0}),i=r.update$.subscribe();return o(r.matching),()=>i?.unsubscribe()},[]),e}import{createEntity as st,getComponentValue as U,overridableComponent as ee,updateComponent as w,setComponent as mt}from"@latticexyz/recs";import{mapObject as ct,awaitStreamValue as dt,uuid as pt}from"@latticexyz/utils";var V=(a=>(a[a.Requested=0]="Requested",a[a.Executing=1]="Executing",a[a.WaitingForTxEvents=2]="WaitingForTxEvents",a[a.Complete=3]="Complete",a[a.Failed=4]="Failed",a[a.Cancelled=5]="Cancelled",a[a.TxReduced=6]="TxReduced",a))(V||{}),at={[6]:"TxReduced",[0]:"Requested",[1]:"Executing",[2]:"WaitingForTxEvents",[3]:"Complete",[4]:"Failed",[5]:"Cancelled"};import{merge as ut}from"rxjs";function lt(t,e){let o=F(t),r={},i=new Map,u=new Map;t.registerDisposer(()=>{for(let{dispose:n}of u.values())n()});function d(n){let l=r[n.id]||ee(n);return r[n.id]||(r[n.id]=l),l}function a(n){if(t.hasEntity(n.id))return console.warn(`Action with id ${n.id} is already requested.`),n.id;let f=st(t,void 0,{id:n.id});mt(o,f,{state:0,on:n.on,metadata:n.metadata,overrides:void 0,txHash:void 0});for(let[y,S]of Object.entries(n.components))r[y]||(r[y]=ee(S));let p={...n,entity:f,componentsWithOptimisticUpdates:ct(n.components,y=>d(y))};i.set(p.id,p);let b=ut(...Object.values(p.componentsWithOptimisticUpdates).map(y=>y.update$)).subscribe(()=>c(p));return c(p),u.set(p.id,{dispose:()=>b?.unsubscribe()}),f}function c(n){if(U(o,n.entity)?.state!==0)return;let l=n.requirement(n.componentsWithOptimisticUpdates);l&&s(n,l)}async function s(n,l){if(U(o,n.entity)?.state!==0)return;w(o,n.entity,{state:1});let f=n.updates(n.componentsWithOptimisticUpdates,l).map(p=>({...p,id:pt()}));w(o,n.entity,{overrides:f.map(p=>`${p.id}/${p.component}`)});for(let{component:p,value:b,entity:y,id:S}of f)r[p].addOverride(S,{entity:y,value:b});try{let p=await n.execute(l);if(p){w(o,n.entity,{state:2,txHash:p.hash});let b=p.wait().catch(()=>m(n));await dt(e,y=>y===p.hash),w(o,n.entity,{state:6}),n.awaitConfirmation&&await b}w(o,n.entity,{state:3})}catch{m(n)}C(n.id)}function m(n){w(o,n.entity,{state:4}),C(n.id)}function x(n){let l=i.get(n);return!l||U(o,l.entity)?.state!==0?(console.warn(`Action ${n} was not found or is not in the "Requested" state.`),!1):(w(o,l.entity,{state:5}),C(n),!0)}function C(n){if(!i.get(n))throw new Error("Trying to remove an action that does not exist.");let f=n,p=f!=null&&U(o,f)?.overrides||[];for(let b of p){let[y,S]=b.split("/");r[S].removeOverride(y)}u.get(n)?.dispose(),u.delete(n),i.delete(n),f!=null&&setTimeout(()=>t.deleteEntity(f),5e3)}return{add:a,cancel:x,withOptimisticUpdates:d,Action:o}}async function te(t,e){return K(t,e,[{state:5},{state:4},{state:3}])}import{createNetwork as Wt,createContracts as Ot,createTxQueue as Rt,createSyncWorker as Ht,InputType as Dt,SingletonID as me}from"@latticexyz/network";import{BehaviorSubject as Vt,concatMap as Ut,from as Pt,Subject as Bt}from"rxjs";import{defineComponent as ce,Type as W}from"@latticexyz/recs";import{computed as Ft}from"mobx";import{keccak256 as $t,TableId as jt}from"@latticexyz/utils";import{IWorldKernel__factory as de}from"@latticexyz/world/types/ethers-contracts/factories/IWorldKernel.sol/IWorldKernel__factory";import{ack as ne,createEncoder as ft,isNetworkComponentUpdateEvent as yt,isSystemCallEvent as gt}from"@latticexyz/network";import{getComponentValue as bt,removeComponent as Ct,setComponent as St,getComponentEntities as xt,getComponentValueStrict as vt,updateComponent as Tt}from"@latticexyz/recs";import{isDefined as ht,toEthAddress as It}from"@latticexyz/utils";import Et from"@latticexyz/solecs/abi/Component.sol/Component.json";import{Contract as wt,BigNumber as At}from"ethers";import{filter as Mt,map as Nt,Subject as Q,timer as kt}from"rxjs";function ar(t,e,o){return r=>{let i=r.entity??t.registerEntity({id:r.entity}),u=o[r.component],d=e[u];if(!u){console.error(`Component mapping not found for component ID ${r.component} ${JSON.stringify(r.value)}`);return}return{...r,entity:i,component:d}}}function sr(t,e,o,r,i){let u=e.reduce((d,a)=>({...d,[a]:new Q}),{});return{systemCallStreams:u,decodeAndEmitSystemCall:d=>{let{tx:a}=d,c=At.from(a.to).toHexString().toLowerCase();if(!c)return;let s=bt(o,c)?.value;if(!s)return;let{name:m,contract:x}=r(s),C=x.interface.parseTransaction({data:a.data,value:a.value});u[m]||(u[m]=new Q),u[m].next({...d,updates:d.updates.map(i).filter(ht),systemId:m,args:C.args})}}}async function re(t,e,o){let r={};async function i(d){let a=It(d),c=vt(e,d).value;console.info("[SyncUtils] Creating encoder for "+a);let s=new wt(a,Et.abi,o.get()),[m,x]=await s.getSchema();r[c]=ft(m,x)}for(let d of xt(e))i(d);let u=e.update$.subscribe(d=>i(d.entity));return t.registerDisposer(()=>u?.unsubscribe()),r}function ie(t,e,o,r,i,u,d,a){let c=new Q,s=!1,m=kt(0,100).pipe(Mt(()=>!s),Nt(()=>ne)).subscribe(i),x=o.subscribe(C=>{s=!0;for(let n of C)if(yt(n)){if(n.lastEventInTx&&c.next(n.txHash),d&&u){let{namespace:b,table:y,key:S}=n,E=u.tables[y];if(!(!E||b!==u.namespace)){let O=oe(S,Object.getOwnPropertyNames(E.keySchema)),R=n.value??n.partialValue;if(R){let H=oe(R,Object.getOwnPropertyNames(E.schema));d.set(b,y,O,H)}else d.remove(b,y,O)}}let l=n.entity??t.registerEntity({id:n.entity}),f=r[n.component];if(!f){console.warn("Unknown component:",n);continue}let p=e[f];n.partialValue!==void 0?Tt(p,l,n.partialValue,n.initialValue):n.value===void 0?Ct(p,l):St(p,l,n.value)}else a&&gt(n)&&a(n);i.next(ne),s=!1});return t.registerDisposer(()=>{x?.unsubscribe(),m?.unsubscribe()}),{txReduced$:c.asObservable()}}function oe(t,e){let o={};return e.forEach((r,i)=>{i in t&&(o[r]=t[i])}),o}import{TableId as N}from"@latticexyz/utils";import{defineComponent as k,Type as T}from"@latticexyz/recs";function ae(t){return{Hooks:(()=>{let e=new N("mudstore","Hooks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Callbacks:(()=>{let e=new N("mudstore","Callbacks");return k(t,{value:T.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),StoreMetadata:(()=>{let e=new N("mudstore","StoreMetadata");return k(t,{tableName:T.String,abiEncodedFieldNames:T.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Mixed:(()=>{let e=new N("mudstore","Mixed");return k(t,{u32:T.Number,u128:T.BigInt,a32:T.NumberArray,s:T.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Vector2:(()=>{let e=new N("mudstore","Vector2");return k(t,{x:T.Number,y:T.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})()}}import{TableId as h}from"@latticexyz/utils";import{defineComponent as I,Type as g}from"@latticexyz/recs";function se(t){return{NamespaceOwner:(()=>{let e=new h("","NamespaceOwner");return I(t,{owner:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),ResourceAccess:(()=>{let e=new h("","ResourceAccess");return I(t,{access:g.Boolean},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),InstalledModules:(()=>{let e=new h("","InstalledModules");return I(t,{moduleAddress:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),Systems:(()=>{let e=new h("","Systems");return I(t,{system:g.String,publicAccess:g.Boolean},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),SystemRegistry:(()=>{let e=new h("","SystemRegistry");return I(t,{resourceSelector:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),SystemHooks:(()=>{let e=new h("","SystemHooks");return I(t,{value:g.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),ResourceType:(()=>{let e=new h("","ResourceType");return I(t,{resourceType:g.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),FunctionSelectors:(()=>{let e=new h("","FunctionSelector");return I(t,{namespace:g.String,name:g.String,systemFunctionSelector:g.String},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),KeysInTable:(()=>{let e=new h("","KeysInTable");return I(t,{keys0:g.StringArray,keys1:g.StringArray,keys2:g.StringArray,keys3:g.StringArray,keys4:g.StringArray},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})(),UsedKeysIndex:(()=>{let e=new h("","UsedKeysIndex");return I(t,{has:g.Boolean,index:g.Number},{metadata:{contractId:e.toHexString(),tableId:e.toString()}})})()}}import{createDatabase as Lt,createDatabaseClient as Kt}from"@latticexyz/store-cache";async function Hr({networkConfig:t,world:e,contractComponents:o,initialGasPrice:r,fetchSystemCalls:i,syncThread:u,storeConfig:d,syncStoreCache:a=!0,worldAbi:c=de.abi}){_.next(c);let s=D(e,{id:"SystemsRegistry",metadata:{contractId:"world.component.systems"}}),m=D(e,{id:"ComponentsRegistry",metadata:{contractId:"world.component.components"}}),x=ce(e,{state:W.Number,msg:W.String,percentage:W.Number},{id:"LoadingState",metadata:{contractId:"component.LoadingState"}}),C=new jt("mudstore","schema"),n=ce(e,{valueSchema:W.String,keySchema:W.String},{metadata:{contractId:C.toHexString(),tableId:C.toString()}}),l=ae(e),f=se(e),p={storeSchemaComponent:n,...l,...f,...o,SystemsRegistry:s,ComponentsRegistry:m,LoadingState:x},b={};function y(v,B){let{contractId:we,tableId:J}=B.metadata;J?b[J]=v:b[$t(we)]=v}for(let v of Object.keys(p))y(v,p[v]);let S=await Wt(t);e.registerDisposer(S.dispose);let E=Ft(()=>S.signer.get()||S.providers.get().json),{contracts:O,config:R}=await Ot({config:{World:{abi:de.abi,address:t.worldAddress}},signerOrProvider:E}),H=new Vt(r||Math.ceil((await E.get().getGasPrice()).toNumber()*1.3)),{txQueue:fe,dispose:ye}=Rt(O,S,H,{devMode:t.devMode});e.registerDisposer(ye);let ge=e.registerEntity({id:me}),P=S.connectedAddress.get(),be=P?e.registerEntity({id:P}):void 0,q=new Bt,{provider:{externalProvider:Jt,...Ce},...Se}=t,{ecsEvents$:G,input$:xe,dispose:ve}=Ht(q,{thread:u});e.registerDisposer(ve);function Te(v,B){xe.next({type:Dt.Config,data:{...Se,provider:Ce,worldContract:R.World,initialBlockNumber:B??t.initialBlockNumber,disableCache:t.disableCache||[31337,1337].includes(t.chainId),fetchSystemCalls:i,initialRecords:v}})}let he=Lt(),z=Kt(he,d),{txReduced$:Ie}=ie(e,p,G,b,q,a?d:void 0,a?z:void 0),Ee=t.encoders?re(e,m,E):new Promise(v=>v({}));return{txQueue:fe,txReduced$:Ie,encoders:Ee,network:S,startSync:Te,gasPriceInput$:H,ecsEvent$:G.pipe(Ut(v=>Pt(v))),mappings:b,registerComponent:y,networkConfig:t,world:e,components:p,singletonEntityId:me,singletonEntity:ge,playerEntityId:P,playerEntity:be,storeCache:z}}import{generatePrivateKey as Qt,privateKeyToAccount as le}from"viem/accounts";import{isHex as qt}from"viem";import{BehaviorSubject as pe}from"rxjs";function ue(t,e){if(!qt(t))throw console.error("Private key found in cache is not valid hex",{privateKey:t,cacheKey:e}),new Error(`Private key found in cache (${e}) is not valid hex`);le(t)}function Gt(t="mud:burnerWallet"){let e=localStorage.getVoxelType(t);e!=null&&ue(e,t);let o=e!=null?new pe(e):(()=>{let r=Qt();return console.log("New burner wallet created:",le(r)),localStorage.setVoxelType(t,r),new pe(r)})();return window.addEventListener("storage",function r(i){if(o.closed){window.removeEventListener("storage",r);return}if(i.key===t&&i.storageArea===localStorage){if(!i.newValue){console.warn("Burner wallet removed from cache! You may need to reload to create a new wallet.");return}ue(i.newValue,t),o.next(i.newValue)}}),o}export{V as ActionState,at as ActionStateString,ie as applyNetworkUpdates,lt as createActionSystem,ar as createDecodeNetworkComponentUpdate,re as createEncoders,sr as createSystemCallStreams,F as defineActionComponent,De as defineBoolComponent,Ue as defineCoordComponent,Ne as defineDevHighlightComponent,Oe as defineNumberComponent,D as defineStringComponent,je as defineVoxelCoordComponent,Xn as findEntityWithComponentInRelationshipChain,Zn as findInRelationshipChain,Gt as getBurnerWallet,zn as getCurrentTurn,Ze as getGameConfig,_n as getPlayerEntity,eo as getStringColor,Xe as getTurnAtTime,Jn as isUntraversable,et as randomColor,Yn as resolveRelationshipChain,Hr as setupMUDV2Network,uo as useComponentValueStream,lo as useQuery,it as useStream,te as waitForActionCompletion,to as waitForComponentValue,K as waitForComponentValueIn};
 //# sourceMappingURL=index.js.map